<?xml version="1.0" encoding="utf-8" ?>
<local:AutomatedPage
    x:Class="TeacherToolbox.Controls.Clock"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:converters="using:TeacherToolbox.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:TeacherToolbox.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:model="using:TeacherToolbox.Model"
    xmlns:viewmodels="using:TeacherToolbox.ViewModels"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    mc:Ignorable="d">

    <!--  Design-time DataContext  -->
    <d:Page.DataContext>
        <viewmodels:ClockViewModel />
    </d:Page.DataContext>

    <Grid
        x:Name="MainGrid"
        Margin="5"
        AutomationProperties.Name="ExamClock">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="2*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="5*" />
            <RowDefinition Height="4*" />
            <RowDefinition Height="Auto" MinHeight="40" />
        </Grid.RowDefinitions>

        <TeachingTip
            x:Name="ClockInstructionTip"
            Title="Exam Clock Controls"
            AutomationProperties.AutomationId="ClockInstructionTip"
            CloseButtonContent="Got it!"
            IsLightDismissEnabled="True"
            PlacementMargin="20"
            PreferredPlacement="Bottom"
            Subtitle="Left-click and drag to create time segments. Right-click to remove segments." />

        <Viewbox
            Grid.Row="0"
            Grid.RowSpan="3"
            Grid.Column="0"
            Stretch="Uniform">
            <Canvas
                x:Name="Container"
                Width="200"
                Height="200"
                AutomationProperties.AutomationId="ExamClockCanvas"
                AutomationProperties.Name="ExamClockCanvas"
                Background="Transparent"
                PointerCanceled="Clock_Pointer_Exited"
                PointerExited="Clock_Pointer_Exited"
                PointerMoved="Clock_Pointer_Moved"
                PointerPressed="Clock_Pointer_Pressed"
                PointerReleased="Clock_Pointer_Released">

                <!--  Clock Face  -->
                <Ellipse
                    x:Name="Face"
                    Canvas.Left="0"
                    Canvas.Top="0"
                    Width="200"
                    Height="200"
                    Fill="Transparent" />

                <!--  Time Slice Gauges (dynamically added)  -->
                <!--  These will be added programmatically in code-behind  -->

                <!--  Clock Background Image  -->
                <Image
                    x:Name="ClockBackgroundImage"
                    Canvas.Left="0"
                    Canvas.Top="0"
                    Width="200"
                    Height="200" />
            </Canvas>
        </Viewbox>

        <!--  Centre Number section - shown when Mock Mode is OFF  -->
        <Viewbox
            x:Name="CentreNumberViewbox"
            Grid.Row="0"
            Grid.Column="1"
            Margin="5"
            Visibility="{x:Bind ViewModel.IsNotMockMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBox
                x:Name="centreTextBox"
                Padding="4"
                FontWeight="Bold"
                Header="Centre Number"
                Text="{x:Bind ViewModel.CentreText, Mode=TwoWay}"
                TextAlignment="Center"
                TextWrapping="NoWrap" />
        </Viewbox>

        <!--  Mock Mode Controls - shown when Mock Mode is ON  -->
        <Grid
            x:Name="MockControlsGrid"
            Grid.Row="0"
            Grid.Column="1"
            Margin="10"
            Visibility="{x:Bind ViewModel.IsMockMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock
                Grid.Row="0"
                Margin="0,0,0,10"
                HorizontalAlignment="Center"
                FontWeight="Bold"
                Text="Mock Mode Controls" />

            <!--  Time Adjustment Controls  -->
            <StackPanel
                Grid.Row="1"
                Margin="0,5"
                HorizontalAlignment="Center"
                Orientation="Horizontal">
                <Button
                    x:Name="MinuteBackButton"
                    Margin="2"
                    Command="{x:Bind ViewModel.NudgeTimeCommand}"
                    CommandParameter="-1"
                    Content="◀ -1 Min" />
                <Button
                    x:Name="MinuteForwardButton"
                    Margin="2"
                    Command="{x:Bind ViewModel.NudgeTimeCommand}"
                    CommandParameter="1"
                    Content="+1 Min ▶" />
            </StackPanel>

            <!--  Pause/Resume Button  -->
            <Button
                x:Name="PauseResumeButton"
                Grid.Row="2"
                MinWidth="100"
                Margin="0,5"
                HorizontalAlignment="Center"
                Command="{x:Bind ViewModel.TogglePauseCommand}"
                Content="{x:Bind ViewModel.IsPaused, Mode=OneWay, Converter={StaticResource PauseResumeTextConverter}}" />

            <!--  Sound Toggle  -->
            <CheckBox
                x:Name="SoundEnabledCheckBox"
                Grid.Row="3"
                Margin="0,5"
                HorizontalAlignment="Center"
                Content="Play sound on segment end"
                IsChecked="{x:Bind ViewModel.IsSoundEnabled, Mode=TwoWay}" />
        </Grid>

        <!--  Digital Time Display with constrained height  -->
        <Grid
            Grid.Row="1"
            Grid.Column="1"
            VerticalAlignment="Center">
            <Viewbox MaxHeight="100" Tapped="Digital_Time_Tapped">
                <TextBlock
                    x:Name="digitalTimeTextBlock"
                    VerticalAlignment="Center"
                    Text="{x:Bind ViewModel.DigitalTimeText, Mode=OneWay}" />
                <FlyoutBase.AttachedFlyout>
                    <TimePickerFlyout
                        x:Name="timePickerFlyout"
                        ClockIdentifier="12HourClock"
                        TimePicked="TimePickerFlyout_TimePicked" />
                </FlyoutBase.AttachedFlyout>
            </Viewbox>
        </Grid>

        <!--  Mock Mode Checkbox in its own row  -->
        <CheckBox
            x:Name="MockModeCheckBox"
            Grid.Row="2"
            Grid.Column="1"
            Margin="0,5,10,5"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            Content="Mock Mode"
            IsChecked="{x:Bind ViewModel.IsMockMode, Mode=TwoWay}" />
    </Grid>

    <Page.Resources>
        <converters:PauseResumeTextConverter x:Key="PauseResumeTextConverter" />
    </Page.Resources>
</local:AutomatedPage>