<?xml version="1.0" encoding="utf-8" ?>
<local:AutomatedPage
    x:Class="TeacherToolbox.Controls.Clock"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:converters="using:TeacherToolbox.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:TeacherToolbox.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:model="using:TeacherToolbox.Model"
    xmlns:viewmodels="using:TeacherToolbox.ViewModels"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    mc:Ignorable="d">

    <!--  Design-time DataContext  -->
    <d:Page.DataContext>
        <viewmodels:ClockViewModel />
    </d:Page.DataContext>

    <Grid
        x:Name="MainGrid"
        Margin="5"
        AutomationProperties.Name="ExamClock">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="2*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="7*" />
            <RowDefinition Height="2*" />
            <RowDefinition Height="Auto" MinHeight="40" />
        </Grid.RowDefinitions>

        <TeachingTip
            x:Name="ClockInstructionTip"
            Title="Exam Clock Controls"
            AutomationProperties.AutomationId="ClockInstructionTip"
            CloseButtonContent="Got it!"
            IsLightDismissEnabled="True"
            PlacementMargin="20"
            PreferredPlacement="Bottom"
            Subtitle="Left-click and drag to create time segments. Right-click to remove segments." />

        <Viewbox
            Grid.Row="0"
            Grid.RowSpan="3"
            Grid.Column="0"
            Stretch="Uniform">
            <Canvas
                x:Name="Container"
                Width="200"
                Height="200"
                AutomationProperties.AutomationId="ExamClockCanvas"
                AutomationProperties.Name="ExamClockCanvas"
                Background="Transparent"
                PointerCanceled="Clock_Pointer_Exited"
                PointerExited="Clock_Pointer_Exited"
                PointerMoved="Clock_Pointer_Moved"
                PointerPressed="Clock_Pointer_Pressed"
                PointerReleased="Clock_Pointer_Released">

                <!--  Clock Face  -->
                <Ellipse
                    x:Name="Face"
                    Canvas.Left="0"
                    Canvas.Top="0"
                    Width="200"
                    Height="200"
                    Fill="Transparent" />

                <!--  Time Slice Gauges (dynamically added)  -->
                <!--  These will be added programmatically in code-behind  -->

                <!--  Clock Background Image  -->
                <Image
                    x:Name="ClockBackgroundImage"
                    Canvas.Left="0"
                    Canvas.Top="0"
                    Width="200"
                    Height="200" />
            </Canvas>
        </Viewbox>

        <!--  Centre Number section - shown when Mock Mode is OFF  -->
        <Viewbox
            x:Name="CentreNumberViewbox"
            Grid.Row="0"
            Grid.Column="1"
            Margin="5"
            Visibility="{x:Bind ViewModel.IsNotMockMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBox
                x:Name="centreTextBox"
                Padding="4"
                FontWeight="Bold"
                Header="Centre Number"
                Text="{x:Bind ViewModel.CentreText, Mode=TwoWay}"
                TextAlignment="Center"
                TextWrapping="NoWrap" />
        </Viewbox>

        <!--  Mock Mode Controls - shown when Mock Mode is ON (now properly scaled and extended)  -->
        <Viewbox
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.Column="1"
            Margin="5"
            Stretch="Uniform"
            StretchDirection="Both"
            Visibility="{x:Bind ViewModel.IsMockMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid
                x:Name="MockControlsGrid"
                Width="280"
                Height="380">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock
                    Grid.Row="0"
                    Margin="0,0,0,18"
                    HorizontalAlignment="Center"
                    FontSize="16"
                    FontWeight="Bold"
                    Text="Mock Mode Controls" />

                <!--  Large Time Adjustment Controls (+/- 5 minutes)  -->
                <StackPanel
                    Grid.Row="1"
                    Margin="0,10"
                    HorizontalAlignment="Center"
                    Orientation="Horizontal">
                    <Button
                        x:Name="FiveMinutesBackButton"
                        Width="125"
                        Height="40"
                        Margin="4"
                        Command="{x:Bind ViewModel.NudgeTimeCommand}"
                        CommandParameter="-5"
                        Content="◀◀ -5 Min" />
                    <Button
                        x:Name="FiveMinutesForwardButton"
                        Width="125"
                        Height="40"
                        Margin="4"
                        Command="{x:Bind ViewModel.NudgeTimeCommand}"
                        CommandParameter="5"
                        Content="+5 Min ▶▶" />
                </StackPanel>

                <!--  Small Time Adjustment Controls (+/- 1 minute)  -->
                <StackPanel
                    Grid.Row="2"
                    Margin="0,10"
                    HorizontalAlignment="Center"
                    Orientation="Horizontal">
                    <Button
                        x:Name="MinuteBackButton"
                        Width="125"
                        Height="40"
                        Margin="4"
                        Command="{x:Bind ViewModel.NudgeTimeCommand}"
                        CommandParameter="-1"
                        Content="◀ -1 Min" />
                    <Button
                        x:Name="MinuteForwardButton"
                        Width="125"
                        Height="40"
                        Margin="4"
                        Command="{x:Bind ViewModel.NudgeTimeCommand}"
                        CommandParameter="1"
                        Content="+1 Min ▶" />
                </StackPanel>

                <!--  Pause/Resume Button with Icons  -->
                <Button
                    x:Name="PauseResumeButton"
                    Grid.Row="3"
                    Width="140"
                    Height="45"
                    Margin="0,12"
                    HorizontalAlignment="Center"
                    Command="{x:Bind ViewModel.TogglePauseCommand}">
                    <StackPanel Orientation="Horizontal">
                        <FontIcon
                            Margin="0,0,8,0"
                            FontFamily="Segoe MDL2 Assets"
                            FontSize="18"
                            Glyph="{x:Bind ViewModel.IsPaused, Mode=OneWay, Converter={StaticResource PauseResumeIconConverter}}" />
                        <TextBlock FontSize="14" Text="{x:Bind ViewModel.IsPaused, Mode=OneWay, Converter={StaticResource PauseResumeTextConverter}}" />
                    </StackPanel>
                </Button>

                <!--  Sound Toggle  -->
                <CheckBox
                    x:Name="SoundEnabledCheckBox"
                    Grid.Row="4"
                    Margin="0,12"
                    HorizontalAlignment="Center"
                    Content="Play sound on segment end"
                    FontSize="12"
                    IsChecked="{x:Bind ViewModel.IsSoundEnabled, Mode=TwoWay}" />
            </Grid>
        </Viewbox>

        <!--  Digital Time Display with constrained height  -->
        <Grid
            Grid.Row="1"
            Grid.Column="1"
            VerticalAlignment="Center">
            <Viewbox Tapped="Digital_Time_Tapped">
                <TextBlock
                    x:Name="digitalTimeTextBlock"
                    VerticalAlignment="Center"
                    Text="{x:Bind ViewModel.DigitalTimeText, Mode=OneWay}" />
                <FlyoutBase.AttachedFlyout>
                    <TimePickerFlyout
                        x:Name="timePickerFlyout"
                        ClockIdentifier="12HourClock"
                        TimePicked="TimePickerFlyout_TimePicked" />
                </FlyoutBase.AttachedFlyout>
            </Viewbox>
        </Grid>

        <!--  Mock Mode Checkbox in its own row  -->
        <CheckBox
            x:Name="MockModeCheckBox"
            Grid.Row="2"
            Grid.Column="1"
            Margin="0,5,10,5"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            Content="Mock Mode"
            IsChecked="{x:Bind ViewModel.IsMockMode, Mode=TwoWay}" />
    </Grid>

    <Page.Resources>
        <converters:PauseResumeTextConverter x:Key="PauseResumeTextConverter" />
        <converters:PauseResumeIconConverter x:Key="PauseResumeIconConverter" />
    </Page.Resources>
</local:AutomatedPage>